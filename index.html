<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Live Translator</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    select, button, input { padding: 10px; font-size: 16px; }
    button { cursor: pointer; }
    .pill { padding: 6px 10px; border-radius: 999px; background: #eee; }
    #liveBox, #log { width: 100%; min-height: 90px; padding: 12px; border: 1px solid #ddd; border-radius: 10px; }
    #log { min-height: 180px; }
    .item { border-top: 1px solid #eee; padding: 10px 0; }
    .mono { font-family: ui-monospace, Menlo, Consolas, monospace; }
  </style>
</head>
<body>

<h2>Live Translator</h2>

<div class="row">
  <label>Input:
    <select id="inputLang">
      <option value="en-US" selected>English</option>
      <option value="es-ES">Spanish</option>
      <option value="fr-FR">French</option>
      <option value="de-DE">German</option>
      <option value="pt-BR">Portuguese</option>
      <option value="ja-JP">Japanese</option>
      <option value="ko-KR">Korean</option>
      <option value="zh-CN">Chinese</option>
    </select>
  </label>

  <label>Output:
    <select id="outputLang">
      <option value="es" selected>Spanish</option>
      <option value="en">English</option>
      <option value="fr">French</option>
      <option value="de">German</option>
      <option value="pt">Portuguese</option>
      <option value="ja">Japanese</option>
      <option value="ko">Korean</option>
      <option value="zh">Chinese</option>
    </select>
  </label>

  <button id="toggleBtn">â–¶ Start</button>
  <span id="status" class="pill">Idle</span>
</div>

<div class="row" style="margin-top:10px;">
  <label>Worker URL:
    <input id="translateUrl" style="width:380px"
      value="https://40-live-translator.cunninghamsamuelj.workers.dev/translate">
  </label>
</div>

<div class="row" style="margin-top:10px;">
  <label>Silence (ms)
    <input id="silenceMs" type="number" value="900">
  </label>
  <label>Max chars
    <input id="maxChars" type="number" value="220">
  </label>
  <label>Max age (ms)
    <input id="maxAgeMs" type="number" value="8000">
  </label>
</div>

<h3>Live</h3>
<div id="liveBox" class="mono"></div>

<h3>Translations</h3>
<div id="log"></div>

<script>
(() => {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    alert("Use Chrome or Edge on Android.");
    return;
  }

  const recognition = new SpeechRecognition();
  recognition.continuous = true;
  recognition.interimResults = true;

  const inputLang = document.getElementById("inputLang");
  const outputLang = document.getElementById("outputLang");
  const toggleBtn = document.getElementById("toggleBtn");
  const statusEl = document.getElementById("status");
  const liveBox = document.getElementById("liveBox");
  const log = document.getElementById("log");

  const silenceMsEl = document.getElementById("silenceMs");
  const maxCharsEl = document.getElementById("maxChars");
  const maxAgeMsEl = document.getElementById("maxAgeMs");
  const translateUrlEl = document.getElementById("translateUrl");

  let running = false;
  let chunkFinal = [];
  let chunkInterim = "";
  let chunkStart = 0;
  let silenceTimer = null;
  let ageTimer = null;
  let translating = false;
  let history = [];

  function setStatus(t){ statusEl.textContent = t; }

  function updateLive(){
    liveBox.textContent = (chunkFinal.join(" ") + " " + chunkInterim).trim();
  }

  function clearTimers(){
    if (silenceTimer) clearTimeout(silenceTimer);
    if (ageTimer) clearTimeout(ageTimer);
    silenceTimer = ageTimer = null;
  }

  function armSilence(){
    clearTimeout(silenceTimer);
    silenceTimer = setTimeout(() => flush("silence"), Number(silenceMsEl.value));
  }

  function armAge(){
    clearTimeout(ageTimer);
    ageTimer = setTimeout(() => flush("maxAge"), Number(maxAgeMsEl.value));
  }

  async function translate(text){
    const payload = {
      q: text,
      source: inputLang.value.split("-")[0],
      target: outputLang.value,
      format: "text"
    };

    const r = await fetch(translateUrlEl.value, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!r.ok) throw new Error(await r.text());
    const j = await r.json();
    return j.translatedText;
  }

  function speak(text){
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = outputLang.value;
    speechSynthesis.speak(u);
  }

  function render(){
    log.innerHTML = history.slice().reverse().map(h => `
      <div class="item">
        <div><b>Heard:</b> ${h.in}</div>
        <div><b>Translation:</b> ${h.out}</div>
        <button onclick="speechSynthesis.cancel(); speechSynthesis.speak(new SpeechSynthesisUtterance('${h.out.replace(/'/g,"")}'))">ðŸ”Š Play</button>
      </div>
    `).join("");
  }

  async function flush(reason){
    const text = (chunkFinal.join(" ") + " " + chunkInterim).trim();
    if (!text || translating) return;

    chunkFinal = [];
    chunkInterim = "";
    chunkStart = 0;
    updateLive();
    clearTimers();

    translating = true;
    setStatus("Translatingâ€¦");

    try {
      const out = await translate(text);
      history.push({ in: text, out });
      render();
      speak(out);
      setStatus("Listeningâ€¦");
    } catch {
      setStatus("Translate error");
    } finally {
      translating = false;
    }
  }

  recognition.onresult = e => {
    if (!chunkStart) { chunkStart = Date.now(); armAge(); }
    let interim = "";
    for (let i = e.resultIndex; i < e.results.length; i++) {
      const r = e.results[i];
      const t = r[0].transcript.trim();
      if (r.isFinal) chunkFinal.push(t);
      else interim += " " + t;
    }
    chunkInterim = interim.trim();
    updateLive();
    armSilence();

    const combined = (chunkFinal.join(" ") + chunkInterim).length;
    if (combined > Number(maxCharsEl.value)) flush("maxChars");
  };

  recognition.onend = () => { if (running) recognition.start(); };

  function start(){
    running = true;
    recognition.lang = inputLang.value;
    toggleBtn.textContent = "â¸ Pause";
    setStatus("Listeningâ€¦");
    recognition.start();
  }

  function stop(){
    running = false;
    toggleBtn.textContent = "â–¶ Start";
    setStatus("Idle");
    clearTimers();
    recognition.stop();
  }

  toggleBtn.onclick = () => running ? stop() : start();
})();
</script>
</body>
</html>
